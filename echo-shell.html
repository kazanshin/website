<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>echo-shell</title>

<style>
body {
  font-family: monospace;
  margin: 20px;
}

#out {
  white-space: pre-wrap;
  word-break: break-word;
  overflow-wrap: anywhere;
  max-width: 900px;
  border: 1px solid #ccc;
  padding: 10px;
  margin-top: 10px;
  min-height: 120px;
}

#logPanel {
  display: none;
  white-space: pre-wrap;
  word-break: break-word;
  overflow-wrap: anywhere;
  border: 1px solid #ccc;
  padding: 10px;
  margin-top: 10px;
  max-height: 40vh;
  overflow-y: auto;
  background: #fafafa;
}
</style>
</head>

<body>

<pre id="status">locked</pre>

<textarea id="msg" rows="6" cols="80" placeholder="message"></textarea>
<br>

<button id="send">send</button>
<button id="toggleLogs">logs</button>

<div id="out"></div>
<div id="logPanel"></div>

<script>
let secret = "";

const msgBox = document.getElementById("msg");
const out = document.getElementById("out");
const logPanel = document.getElementById("logPanel");

function unlock() {
  const p = prompt("passphrase:");
  if (!p) return;
  secret = p;
  document.getElementById("status").textContent = "unlocked";
}

unlock();

msgBox.value = localStorage.getItem("echo-draft") || "";

msgBox.addEventListener("input", () => {
  localStorage.setItem("echo-draft", msgBox.value);
});

async function send() {

  const message = msgBox.value.trim();
  if (!message) return;

  localStorage.removeItem("echo-draft");

  out.textContent = "";
  msgBox.value = "";

  const r = await fetch("/api/echo", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "x-echo-secret": secret
    },
    body: JSON.stringify({ message })
  });

  // ✅ Parse as JSON instead of streaming raw text
  const data = await r.json();

  // ✅ Show only the reply field
  out.textContent = data.reply || "(no reply)";
}

document.getElementById("send").onclick = send;

msgBox.addEventListener("keydown", e => {
  if (e.key === "Enter" && (e.ctrlKey || e.metaKey)) {
    e.preventDefault();
    send();
  }
});

document.getElementById("toggleLogs").onclick = async () => {

  if (logPanel.style.display === "block") {
    logPanel.style.display = "none";
    return;
  }

  logPanel.textContent = "loading...";
  logPanel.style.display = "block";

  const r = await fetch("/api/echo?logs=1&limit=100", {
    headers: { "x-echo-secret": secret }
  });

  const j = await r.json();

  if (!Array.isArray(j.logs)) {
    logPanel.textContent = JSON.stringify(j, null, 2);
    return;
  }

  logPanel.textContent = "";

  j.logs.forEach(e => {
    logPanel.textContent +=
      `[${e.ts || ""}] ${e.role || ""}\n${e.content || ""}\n\n`;
  });

  logPanel.scrollTop = logPanel.scrollHeight;
};
</script>


</body>
</html>
